name: Build & Release

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags (e.g., v1.0.0)
  workflow_dispatch:  # Allow manual trigger

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always

jobs:
  # Build for macOS (Universal: Intel + Apple Silicon)
  build-macos:
    name: Build macOS (Universal)
    runs-on: macos-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true
      
      - name: Install Rust targets for Universal binary
        run: |
          rustup target add x86_64-apple-darwin
          rustup target add aarch64-apple-darwin
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install frontend dependencies
        run: npm install
      
      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
      
      - name: Build Tauri app (Universal binary)
        run: npm run tauri:build -- --target universal-apple-darwin
      
      - name: Generate checksums
        run: |
          cd src-tauri/target/release/bundle/dmg
          shasum -a 256 *.dmg > checksums-macos.txt
          cat checksums-macos.txt
      
      - name: Upload macOS DMG
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: |
            src-tauri/target/release/bundle/dmg/*.dmg
            src-tauri/target/release/bundle/dmg/checksums-macos.txt
          retention-days: 90
      
      - name: Upload to Release (if tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            src-tauri/target/release/bundle/dmg/*.dmg
            src-tauri/target/release/bundle/dmg/checksums-macos.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Build for Windows
  build-windows:
    name: Build Windows (x64)
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install frontend dependencies
        run: npm install
      
      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
      
      - name: Build Tauri app
        run: npm run tauri:build
      
      - name: Generate checksums
        shell: bash
        run: |
          cd src-tauri/target/release/bundle/nsis
          sha256sum *.exe > checksums-windows.txt
          cat checksums-windows.txt
      
      - name: Upload Windows installer
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: |
            src-tauri/target/release/bundle/nsis/*.exe
            src-tauri/target/release/bundle/nsis/checksums-windows.txt
          retention-days: 90
      
      - name: Upload to Release (if tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            src-tauri/target/release/bundle/nsis/*.exe
            src-tauri/target/release/bundle/nsis/checksums-windows.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Build for Linux
  build-linux:
    name: Build Linux (x64)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.0-dev \
            build-essential \
            curl \
            wget \
            libssl-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev
      
      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install frontend dependencies
        run: npm install
      
      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
      
      - name: Build Tauri app
        run: npm run tauri:build
      
      - name: Generate checksums
        run: |
          cd src-tauri/target/release/bundle/appimage
          sha256sum *.AppImage > checksums-linux-appimage.txt
          cat checksums-linux-appimage.txt
          cd ../deb
          sha256sum *.deb > checksums-linux-deb.txt
          cat checksums-linux-deb.txt
      
      - name: Upload Linux AppImage
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage
          path: |
            src-tauri/target/release/bundle/appimage/*.AppImage
            src-tauri/target/release/bundle/appimage/checksums-linux-appimage.txt
          retention-days: 90
      
      - name: Upload Linux deb package
        uses: actions/upload-artifact@v4
        with:
          name: linux-deb
          path: |
            src-tauri/target/release/bundle/deb/*.deb
            src-tauri/target/release/bundle/deb/checksums-linux-deb.txt
          retention-days: 90
      
      - name: Upload to Release (if tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            src-tauri/target/release/bundle/appimage/*.AppImage
            src-tauri/target/release/bundle/appimage/checksums-linux-appimage.txt
            src-tauri/target/release/bundle/deb/*.deb
            src-tauri/target/release/bundle/deb/checksums-linux-deb.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Create release summary
  release-summary:
    name: Create Release Summary
    needs: [build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Create release notes
        run: |
          cat > release-notes.md << 'EOF'
          # Yantra ${{ github.ref_name }}
          
          ## Installation
          
          ### macOS (Universal - Intel & Apple Silicon)
          - Download `Yantra_0.1.0_universal.dmg`
          - Open the DMG and drag Yantra to Applications
          - Right-click and select "Open" (first time only, due to Gatekeeper)
          
          ### Windows (x64)
          - Download `Yantra_0.1.0_x64-setup.exe`
          - Run the installer
          - Windows Defender may show a warning (click "More info" â†’ "Run anyway")
          
          ### Linux (x64)
          **AppImage (Universal):**
          - Download `yantra_0.1.0_amd64.AppImage`
          - Make executable: `chmod +x yantra_0.1.0_amd64.AppImage`
          - Run: `./yantra_0.1.0_amd64.AppImage`
          
          **Debian/Ubuntu:**
          - Download `yantra_0.1.0_amd64.deb`
          - Install: `sudo dpkg -i yantra_0.1.0_amd64.deb`
          
          ## Checksums
          
          SHA256 checksums are provided for all packages. Verify with:
          ```bash
          # macOS
          shasum -a 256 -c checksums-macos.txt
          
          # Windows
          sha256sum -c checksums-windows.txt
          
          # Linux
          sha256sum -c checksums-linux-appimage.txt
          sha256sum -c checksums-linux-deb.txt
          ```
          
          ## What's New
          
          - ðŸŽ‰ Phase 1 MVP Complete (314 tests passing)
          - âœ¨ 18 features fully implemented
          - ðŸ”’ Security scanning with auto-fix (Semgrep)
          - ðŸŒ Browser validation (Chrome DevTools Protocol)
          - ðŸ”§ Git integration with AI commit messages
          - ðŸ“¦ Packaging & deployment automation
          - ðŸ–¥ï¸ Real-time UI updates with progress tracking
          
          ## Documentation
          
          - [Features Guide](https://github.com/${{ github.repository }}/blob/main/docs/Features.md)
          - [Manual Testing Guide](https://github.com/${{ github.repository }}/blob/main/docs/Manual_Testing_Guide.md)
          - [Technical Guide](https://github.com/${{ github.repository }}/blob/main/docs/Technical_Guide.md)
          
          ## System Requirements
          
          - **macOS:** 10.15 Catalina or later
          - **Windows:** Windows 10 or later (64-bit)
          - **Linux:** Ubuntu 20.04+ or equivalent (with GTK 3)
          
          ## Known Issues
          
          See [Known_Issues.md](https://github.com/${{ github.repository }}/blob/main/Known_Issues.md)
          
          ## Support
          
          - Report bugs: [GitHub Issues](https://github.com/${{ github.repository }}/issues)
          - Documentation: [GitHub Wiki](https://github.com/${{ github.repository }}/wiki)
          EOF
      
      - name: Update Release with notes
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          body_path: release-notes.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
